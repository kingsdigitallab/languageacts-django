{% if pages %}
{% load cms_tags wagtailcore_tags %}

<ul class="menu vertical subnav">
    {% with pages|get_section as index %}
    <li class="top-level">
        <a href="{% pageurl index %}"{% if page.url == self.url %}
             class="active"{% endif %}>
            {{ index.title }}
        </a>
    </li>
    {% for page in index.get_children %}
    <li>
        <a href="{% pageurl page %}"{% if page.url == self.url %} 
        class="active"{% endif %}>
            {{ page.title }}
        </a>

        <ul class="vertical menu nested">
            {% for sub in page.get_children %} 
            <li>
                <a href="{% pageurl sub %}">
                    {{ sub.title }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </li>
    {% endfor %}

    {% endwith %}
</ul>

{% endif %}